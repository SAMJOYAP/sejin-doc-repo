# Kubernetes에 Postgres 배포: StatefulSet + Headless Service + PVC 구성

---

## 1) 사전 점검 (클러스터 연결/스토리지)

### 클러스터 연결 확인

```bash
kubectl version
kubectl get nodes -o wide
```

### StorageClass 확인

```bash
kubectl get sc
```

- StorageClass가 없으면 PVC가 `Pending` 상태로 남는다.
- 로컬 환경에서는 `local-path-provisioner` 설치가 필요할 수 있다.

---

## 2) 배포 리소스 선택: 왜 StatefulSet 인가?

### Deployment vs StatefulSet

- **Deployment**: Stateless 애플리케이션에 적합.
- **StatefulSet**: DB처럼 **스토리지와 네트워크 ID가 고정**되어야 하는 워크로드에 적합.

### Postgres에서 StatefulSet이 적절한 이유

- Pod 이름이 고정된다(`my-db-0`).
- PVC가 Pod에 **1:1 매핑**되어 데이터가 유지된다.
- 재시작/재스케줄에도 스토리지가 안정적으로 붙는다.

---

## 3) 초기 스키마/데이터 ConfigMap

```bash
vim modules/config-maps/my-db-config-map.yaml
```

```yaml
# modules/config-maps/my-db-config-map.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-db-config-map
data:
  init.sql: |
    CREATE TABLE IF NOT EXISTS counter (id INT PRIMARY KEY, count INT NOT NULL DEFAULT 0);
    INSERT INTO counter (id, count) VALUES (1, 0) ON CONFLICT (id) DO NOTHING;
```

- `init.sql`은 Postgres 초기화 시 자동 실행된다.

---

## 4) DB Secret 생성 (계정/DB 이름)

```bash
vim modules/secrets/my-db-secret.yaml
```

```yaml
# modules/secrets/my-db-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-db-secret
type: Opaque
stringData:
  POSTGRES_USER: myuser
  POSTGRES_PASSWORD: qwer
  POSTGRES_DB: mydb
```

- `stringData`는 사람이 읽기 쉬운 형태로 작성하면 Kubernetes가 base64 인코딩한다.

---

## 5) Headless Service 생성 (StatefulSet 전용)

```bash
vim modules/services/my-db-service.yaml
```

```yaml
# modules/services/my-db-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  clusterIP: None
  selector:
    app: my-db
  ports:
    - port: 5432
      targetPort: 5432
```

- `clusterIP: None`: Headless Service로 설정해 Pod DNS가 고정된다.
- Service 이름이 곧 DB 접속 호스트 이름이 된다(`postgres`).

---

## 6) StatefulSet 생성 (Postgres)

```bash
vim modules/statefulsets/my-db-statefulset.yaml
```

```yaml
# modules/statefulsets/my-db-statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: my-db
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: my-db
  template:
    metadata:
      labels:
        app: my-db
    spec:
      containers:
        - name: postgres
          image: postgres:16
          ports:
            - containerPort: 5432
          envFrom:
            - secretRef:
                name: my-db-secret
          volumeMounts:
            - name: my-db-data
              mountPath: /var/lib/postgresql/data
            - name: initdb
              mountPath: /docker-entrypoint-initdb.d
              readOnly: true
      volumes:
        - name: initdb
          configMap:
            name: my-db-config-map

  volumeClaimTemplates:
    - metadata:
        name: my-db-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 5Gi
```

- `serviceName: postgres`: StatefulSet의 네트워크 ID는 Headless Service 이름과 연결된다.
- `envFrom.secretRef`: DB 계정/DB 이름을 Secret에서 주입.
- `volumeClaimTemplates`: Pod마다 고정 PVC를 생성.
- `initdb` ConfigMap: 초기 테이블 생성 SQL 실행.

---

## 7) 적용 순서

```bash
kubectl apply -f modules/config-maps/my-db-config-map.yaml
kubectl apply -f modules/secrets/my-db-secret.yaml
kubectl apply -f modules/services/my-db-service.yaml
kubectl apply -f modules/statefulsets/my-db-statefulset.yaml
```

---

## 8) 상태 확인

```bash
kubectl get sts my-db
kubectl get pods -l app=my-db -o wide
kubectl get svc postgres -o wide
kubectl get pvc
```

---

## 9) 트러블슈팅 빠른 체크

### PVC가 Pending일 때

```bash
kubectl describe pvc my-db-data-my-db-0
kubectl get sc
```

- StorageClass가 없으면 `Pending`으로 남는다.
- 로컬 환경에서는 `local-path-provisioner` 설치 후 default 설정이 필요하다.

### StatefulSet serviceName 변경

- `serviceName`은 **변경 불가**이므로 변경 시 **StatefulSet 삭제 후 재생성**해야 한다.

---

# 빠른 요약

- Postgres는 Stateful 워크로드이므로 StatefulSet으로 배포한다.
- Headless Service를 통해 안정적인 DNS를 제공한다.
- PVC가 바인딩되지 않으면 DB Pod는 Pending이 된다.

---
