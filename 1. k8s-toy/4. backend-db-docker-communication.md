# Node.js + PostgreSQL Docker 구성: 이미지화 및 통신 커맨드 정리

---

## 1) Node.js 애플리케이션 Docker 이미지화

### 프로젝트 구조

```bash
.
├── Dockerfile
├── docker-compose.yaml
├── package.json
├── package-lock.json
├── db
│   └── init.sql
└── src
    └── index.js
```

### Node.js 로직

```bash
import express, { Request, Response } from 'express';
import { Pool } from 'pg';
import cors from 'cors';

const app = express();
const PORT = 3000;

app.use(
  cors({
    origin: ['http://localhost:8080'], // 프론트 주소
  }),
);

export const pool = new Pool({
  host: process.env.POSTGRES_HOST,
  port: Number(process.env.POSTGRES_PORT),
  user: process.env.POSTGRES_USER,
  password: process.env.POSTGRES_PASSWORD,
  database: process.env.POSTGRES_NAME,
});

app.get('/api', (req: Request, res: Response) => {
  res.send('Hello Express + TypeScript!');
});

app.get('/api/count', async (req: Request, res: Response) => {
  try {
    const result = await pool.query('SELECT count FROM counter WHERE id = 1');

    res.json({
      success: true,
      count: result.rows[0]?.count ?? 0,
    });
  } catch (err) {
    console.error(err);
    res.status(500).json({ success: false });
  }
});
```

### Dockerfile

```dockerfile
FROM node:20-alpine

WORKDIR /app

COPY package\*.json ./
RUN npm install

COPY . .

EXPOSE 3000

CMD ["npm", "run", "start"]
```

### docker-compose.yaml

```bash
services:
  postgres:
    image: postgres:16
    container_name: my-postgres
    environment:
      POSTGRES_USER: myuser
      POSTGRES_PASSWORD: qwer
      POSTGRES_DB: mydb
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
    ports:
      - '5432:5432'
    volumes:
      - my-postgres-data:/var/lib/postgresql/data
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  backend:
    build: .
    container_name: my-backend
    depends_on:
      - postgres
    env_file:
      - .env
    ports:
      - '3000:3000'
    command: npm run dev

volumes:
  my-postgres-data:

```

### ./db/init.sql

```bash
CREATE TABLE IF NOT EXISTS counter (
  id INT PRIMARY KEY,
  count INT NOT NULL DEFAULT 0
);

INSERT INTO counter (id, count)
VALUES (1, 0)
ON CONFLICT (id) DO NOTHING;

```

---

## 2) 컨테이너 실행

```bash
docker compose up
```

---

## 3) 연결 확인

```bash
  curl http://localhost:3000/api/count
  # { "success":true,"count":9 }
```

---

# 빠른 요약

- Node.js 백엔드와 PostgreSQL을 docker-compose로 각각 독립 컨테이너로 구성했다.
- PostgreSQL은 공식 이미지(postgres:16) 와 volume을 사용해 데이터 영속성을 확보했다.
- 초기 테이블 및 데이터는 init.sql을 통해 컨테이너 최초 실행 시 자동 초기화된다.
