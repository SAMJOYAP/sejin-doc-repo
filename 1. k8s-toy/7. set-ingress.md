# Kubernetes Ingress 구성: React + Backend 라우팅

---

## 1) 사전 점검 (Ingress Controller)

### Ingress Controller 설치 여부 확인

```bash
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

- `ingress-nginx-controller`가 `Running`이어야 한다.
- NodePort/LoadBalancer 포트로 외부 접속이 가능해야 한다.

### (없다면) 설치

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/baremetal/deploy.yaml
```

---

## 2) 왜 Ingress인가?

- NodePort는 테스트에는 쉽지만 **서비스가 많아질수록 관리가 어렵다**.
- Ingress는 **단일 진입점**으로 여러 서비스(`/`, `/api` 등)를 라우팅한다.
- 외부 노출은 Ingress Controller가 처리하고, 내부 서비스는 ClusterIP로 유지한다.

---

## 3) Service 타입 변경 (React는 ClusterIP)

```bash
vim modules/services/my-react-service.yaml
```

```yaml
# modules/services/my-react-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-react
spec:
  type: ClusterIP
  selector:
    app: my-react
  ports:
    - port: 80
      targetPort: 80
```

- `NodePort` → `ClusterIP`로 변경한다.
- 외부 노출은 Ingress가 담당한다.

---

## 4) Ingress 리소스 작성

```bash
vim modules/ingress/my-app-ingress.yaml
```

```yaml
# modules/ingress/my-app-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-app-ingress
  annotations:
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "http://192.168.76.200"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization,Content-Type"
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: my-node-svc
                port:
                  number: 3000
          - path: /
            pathType: Prefix
            backend:
              service:
                name: my-react
                port:
                  number: 80
```

- `/api` 요청은 Backend(`my-node-svc`)로 라우팅한다.
- `/` 요청은 React Service(`my-react`)로 라우팅한다.
- CORS는 Ingress에서 처리해 **프론트 ↔ 백엔드 통신 문제를 완화**한다.

---

## 5) 적용 순서

```bash
kubectl apply -f modules/services/my-react-service.yaml
kubectl apply -f modules/services/my-node-serivce.yaml
kubectl apply -f modules/ingress/my-app-ingress.yaml
```

---

## 6) 접속 주소 확인

### LoadBalancer가 있을 때

```bash
kubectl get svc -n ingress-nginx
```

- 예시: `EXTERNAL-IP`가 `192.168.76.200`이면
  - 프론트: `http://192.168.76.200/`
  - 백엔드: `http://192.168.76.200/api`

### NodePort일 때

```bash
kubectl get svc -n ingress-nginx
kubectl get nodes -o wide
```

- `ingress-nginx-controller`의 NodePort와 노드 IP를 조합해 접속한다.

---

## 7) 트러블슈팅 빠른 체크

### CORS가 계속 발생할 때

```bash
kubectl describe ingress my-app-ingress
curl -I -H "Origin: http://192.168.76.200" http://192.168.76.200/api
```

- 프론트 접속 주소와 `cors-allow-origin`이 정확히 일치해야 한다.
- 프론트 API 호출을 `/api` 상대경로로 하면 CORS 없이 동작한다.

### 404/라우팅 실패

```bash
kubectl get ingress
kubectl describe ingress my-app-ingress
kubectl get endpoints my-node-svc
```

- Service selector/labels 불일치 여부를 확인한다.

---

# 빠른 요약

- React/Backend는 ClusterIP로 두고, Ingress가 외부 요청을 라우팅한다.
- `/`는 React, `/api`는 Backend로 매핑한다.
- Ingress Controller가 반드시 먼저 설치되어 있어야 한다.

---
