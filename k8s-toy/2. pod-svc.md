# 제목 없음

# Kubernetes에 React 앱 배포: Deployment + NodePort Service 구축

---

## 1) 사전 점검 (클러스터 연결/노드 상태)

### 클러스터 연결 확인

```bash
kubectl version
kubectl get nodes -o wide
```

- `kubectl version`: kubeconfig가 정상이고 API 서버에 연결되는지 확인한다.
- `kubectl get nodes -o wide`: 노드가 모두 `Ready`인지, IP/역할이 정상인지 확인한다.

---

## 2) 배포 리소스 선택: 왜 Deployment를 사용했는가?

### Deployment / StatefulSet / DaemonSet / Job 간단 비교

- **Deployment**
  → Stateless(상태 없는) 애플리케이션을 다중 Pod로 운영하고, 롤링 업데이트/스케일링을 쉽게 하기 위해 사용한다.
- **StatefulSet**
  → Pod 이름/순서/스토리지가 고정되어야 하는 상태ful 워크로드(DB, Kafka 등)에 사용한다.
- **DaemonSet**
  → 모든 노드에 1개씩 떠야 하는 에이전트(로그 수집, 모니터링 등)에 사용한다.
- **Job/CronJob**
  → 한 번 실행 후 종료되는 배치/주기 작업에 사용한다.

### React(Nginx 정적 서빙)에서 Deployment가 적절한 이유

- React 빌드 결과는 **정적 파일**이고, 컨테이너는 이를 **Nginx로 서빙**하는 구조라 **상태가 없다(stateless)**.
- Pod 개수(`replicas`)를 늘려 **가용성/분산**을 확보하기 쉽다.
- 이미지 태그 변경 시 **롤링 업데이트**로 무중단에 가깝게 교체할 수 있다.
- HPA 같은 자동 확장과도 잘 맞는다(향후 확장).

---

## 3) Deployment 생성 (React 컨테이너 실행)

### Deployment YAML 작성

```bash
vim k8s/my-react-deploy.yaml
```

- Deployment는 **컨테이너 이미지를 Pod로 실행**하고, 원하는 개수(`replicas`)를 유지한다.

```yaml
# k8s/my-react-deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-react
spec:
  replicas: 3
  selector:
    matchLabels:
      app: my-react
  template:
    metadata:
      labels:
        app: my-react
    spec:
      containers:
        - name: my-react
          image: sej1991/my-react-vite:v1
          ports:
            - containerPort: 80
          resources:
            requests:
              cpu: '100m'
              memory: '128Mi'
            limits:
              cpu: '300m'
              memory: '256Mi'
```

- `replicas: 3`: Pod를 3개로 유지해 가용성과 분산을 확보한다.
- `matchLabels`/`labels`: Service/Deployment가 Pod를 찾는 기준(서로 반드시 일치해야 함).
- `image: ...:v1`: Kubernetes가 pull할 Docker Hub 이미지를 지정한다.
- `containerPort: 80`: 컨테이너(Nginx)가 80 포트로 정적 파일을 제공한다.
- `requests/limits`: 리소스 최소 보장/상한을 설정해 안정적인 스케줄링과 보호를 한다.

---

### Deployment 적용

```bash
kubectl apply -f k8s/my-react-deploy.yaml
```

- `kubectl apply`: YAML에 정의된 “원하는 상태”를 클러스터에 반영한다(없으면 생성, 있으면 변경 반영).

---

### Deployment 상태 확인

```bash
kubectl get deploy my-react
kubectl get rs
kubectl get pods -o wide
kubectl rollout status deploy/my-react
```

- `kubectl get deploy`: replicas/available 상태를 확인한다.
- `kubectl get rs`: Deployment가 만든 ReplicaSet을 확인한다.
- `kubectl get pods -o wide`: Pod가 어떤 노드에 배치됐는지 확인한다.
- `kubectl rollout status`: 롤링 업데이트/배포가 정상 완료됐는지 확인한다.

---

## 4) Service 생성: NodePort로 외부 접근 만들기

> (클라우드의 LoadBalancer가 없거나, Ingress/MetalLB를 붙이기 전 단계에서 빠르게 접근 확인할 때 자주 사용)

### NodePort Service YAML 작성

```yaml
vim k8s/my-react-svc.yaml

# k8s/my-react-svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: my-react-svc
spec:
  type: NodePort
  selector:
    app: my-react
  ports:
    - name: http
      port: 80
      targetPort: 80
      nodePort: 32333
```

- `type: NodePort`: 모든 노드의 특정 포트(예: 32333)를 열어 외부에서 접근 가능하게 한다.
- `selector.app: my-react`: `app: my-react` 라벨을 가진 Pod로 트래픽을 보낸다.
- `port: 80`: Service 내부 포트(클러스터 관점).
- `targetPort: 80`: Pod 컨테이너가 실제로 듣는 포트(Nginx 80).
- `nodePort: 32333`: 노드에서 열릴 외부 포트(30000~32767 범위). 지정하지 않으면 자동 할당된다.

---

### Service 적용

```bash
kubectl apply -f k8s/my-react-svc.yaml
```

- Service 리소스를 생성/업데이트한다.

---

### Service 상태 확인

```bash
kubectl get svc my-react-svc -o wide
kubectl describe svc my-react-svc
kubectl get endpoints my-react-svc
```

- `get svc -o wide`: NodePort/포트 매핑이 기대대로인지 확인한다.
- `describe svc`: selector 및 이벤트를 확인한다.
- `get endpoints`: Service가 연결하는 Pod 엔드포인트가 생성됐는지 확인한다(없으면 selector/labels 불일치 가능).

---

### 접속 테스트 (NodePort)

```bash
kubectl get nodes -o wide
```

- 노드 IP를 확인한 뒤, 브라우저/CLI에서 아래로 접근한다.

```bash
curl http://<NODE_IP>:32333
```

- `<NODE_IP>`는 `kube-node1/2/3` 중 접근 가능한 노드 IP를 사용한다.
- NodePort는 “모든 노드”에 포트가 열리지만, 내부적으로는 Service가 Pod로 라우팅한다.

---

## 5) 트러블슈팅 빠른 체크

### Pod가 안 뜰 때

```bash
kubectl describe pod <POD_NAME>
kubectl get events --sort-by='.lastTimestamp'
```

- 이미지 pull 실패, 리소스 부족, 스케줄링 실패 등 원인을 확인한다.

### Service에 Endpoint가 없을 때(selector 불일치)

```bash
kubectl get pods --show-labels
kubectl get endpoints my-react-svc
```

- Pod 라벨(`app: my-react`)과 Service selector가 일치하는지 확인한다.

### NodePort 접속이 안 될 때

```bash
sudo ss -lntp | grep 32333
```

- 노드에서 포트가 실제로 열려 있는지 확인한다(환경/방화벽에 따라 차단될 수 있음).
- Vagrant/VirtualBox 환경이면 포트 포워딩/네트워크 설정도 함께 확인한다.

---

# 빠른 요약

- React(Nginx 정적 서빙)는 stateless 워크로드이므로 Deployment를 선택했다.
- Deployment로 `sej1991/my-react-vite:v1` 이미지를 3개 Pod로 실행했다.
- Service는 NodePort로 구성해 `<NODE_IP>:32333`으로 외부 접근을 가능하게 했다.
- 배포/라우팅 상태는 `kubectl get deploy/pods/svc/endpoints`로 확인했다.

---
