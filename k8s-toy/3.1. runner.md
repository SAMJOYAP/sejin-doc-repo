# GitHub Actions Self-hosted Runner 구성: 설치/실행 커맨드 정리

---

## **runner란?**

> GitHub Actions의 job(워크플로우 step들)을 실제로 실행해주는 실행기(에이전트)

- YAML에 적힌:
  - docker build
  - kubectl apply
  - npm run build
- **위의 내용을 실행**해는 주체 → **runner**

## 1) Self-hosted Runner를 쓰는 이유

- GitHub-hosted runner는 외부망 VM이라 **사설망/Vagrant 클러스터(예: 192.168.x.x)** 에 접근이 어려울 수 있다.
- self-hosted runner는 클러스터와 같은 네트워크에 두어 `docker`, `kubectl` 배포 명령을 안정적으로 실행할 수 있다.

---

## 2) Runner 머신 사전 준비 (필수 도구)

### 패키지 업데이트

```bash
sudo apt update
```

- 패키지 목록을 최신으로 갱신한다.

---

### Git, curl 등 기본 도구 설치

```bash
sudo apt install -y git curl ca-certificates
```

- runner 설치 파일 다운로드/관리 시 필요한 기본 도구를 설치한다.
  - ca-certificates: HTTPS 통신에서 서버의 신원을 검증하기 위한 **신뢰된 인증서(CA) 묶음**을 제공하는 패키지

---

## 3) Docker 설치 및 권한 설정 (CI에서 docker build/push 필요)

> runner에서 Docker로 이미지를 빌드/푸시하므로 Docker가 필요하다.

### Docker 설치(환경에 맞게)

```bash
docker version
docker info
```

- Docker가 이미 설치되어 있는지/데몬이 동작하는지 확인한다.

---

### runner 사용자(vagrant)를 docker 그룹에 추가

```bash
sudo usermod -aG docker vagrant
```

- vagrant 사용자가 `sudo` 없이 `docker build`, `docker push`를 실행할 수 있게 한다.
- 적용을 위해 **세션 재로그인** 또는 runner 재시작이 필요할 수 있다.

---

## 4) kubectl 및 kubeconfig 준비 (CI에서 kubectl 필요)

### kubectl 동작 확인

```bash
kubectl version --client
```

- runner 머신에 kubectl이 설치되어 있는지 확인한다.

---

### kubeconfig 준비 (vagrant 사용자로 kubectl 실행 가능하게)

```bash
mkdir -p ~/.kube
sudo cp /etc/kubernetes/admin.conf ~/.kube/config
sudo chown vagrant:vagrant ~/.kube/config
```

- `/etc/kubernetes/admin.conf`(root 권한 kubeconfig)를 사용자 홈으로 복사해,
  runner(vagrant)가 `kubectl`을 실행할 수 있게 한다.
- CI에서 `export KUBECONFIG=/home/vagrant/.kube/config`로 사용한다.

---

## 5) GitHub Actions Runner 설치 (GitHub UI에서 제공하는 명령 그대로 수행)

> 레포에서: Settings → Actions → Runners → New self-hosted runner
>
> 여기서 OS/아키텍처를 선택하면 설치 커맨드가 제공된다.

### (예시) Runner 다운로드/압축 해제

```bash
mkdir actions-runner && cd actions-runner
curl -o actions-runner-linux-x64-<VERSION>.tar.gz -L <https://github.com/actions/runner/releases/download/v><VERSION>/actions-runner-linux-x64-<VERSION>.tar.gz
tar xzf ./actions-runner-linux-x64-<VERSION>.tar.gz
```

- runner 바이너리를 다운로드하고 압축을 해제한다.
- `<VERSION>`은 GitHub 화면에 표시된 값을 그대로 사용한다.

---

### Runner 등록(config)

```bash
./config.sh --url <https://github.com/><OWNER>/<REPO> --token <TOKEN>
```

- runner를 특정 레포에 등록한다.
- `<TOKEN>`은 GitHub UI에서 발급된 1회성 등록 토큰이다.

---

### Runner 실행(포그라운드)

```bash
./run.sh
```

- runner를 실행하면 GitHub Actions가 이 머신에 잡을 할당할 수 있다.
- 터미널을 끄면 runner가 종료된다.

---

## 6) Runner를 백그라운드/서비스로 실행

> 매번 터미널을 붙잡고 있지 않으려면 서비스 등록이 편하다.

### 서비스 설치

```bash
sudo ./svc.sh install
```

- systemd 서비스로 runner를 등록한다.

### 서비스 시작/중지/상태 확인

```bash
sudo ./svc.sh start
sudo ./svc.sh status
sudo ./svc.sh stop
```

- runner를 서비스로 시작하고 상태를 확인한다.

---

# 빠른 요약

- self-hosted runner 머신에 Docker/kubectl을 준비하고, vagrant가 docker/kubeconfig를 사용할 수 있도록 권한을 설정했다.
- GitHub UI에서 제공한 스크립트로 runner를 다운로드/등록하고 `run.sh` 또는 `svc.sh`로 실행했다.
- 워크플로우 배포 단계는 `kubectl set image` + `kubectl rollout status`로 롤링 업데이트를 수행했다.

---
